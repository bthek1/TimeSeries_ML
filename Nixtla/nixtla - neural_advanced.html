<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.39">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Benedict Thekkel">
<meta name="description" content="Model training, evaluation and selection for multiple time series">

<title>Nixtla - Neural Advanced Forecast – TimeSeries_ML</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../Nixtla/nixtla - all_methods.html" rel="next">
<link href="../Nixtla/nixtla - neural_save_and_load.html" rel="prev">
<link href="../favi.svg" rel="icon" type="image/svg+xml">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-e26003cea8cd680ca0c55a263523d882.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-dark-d166b450ba5a8e9f7a0ab969bf6592c1.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-8591a23a4523c05244f862a3a7a9199d.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/bootstrap/bootstrap-dark-e70fbee34635c599973ad3990d9ce4ab.min.css" rel="prefetch" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="../styles.css">
<meta property="og:title" content="Nixtla - Neural Advanced Forecast – TimeSeries_ML">
<meta property="og:description" content="Model training, evaluation and selection for multiple time series">
<meta property="og:image" content="https://bthek1.github.io/TimeSeries_ML/Nixtla/334_Nixtla - Neural_Advanced_files/figure-html/cell-5-output-2.png">
<meta property="og:site_name" content="TimeSeries_ML">
<meta property="og:image:height" content="1161">
<meta property="og:image:width" content="1973">
<meta name="twitter:title" content="Nixtla - Neural Advanced Forecast – TimeSeries_ML">
<meta name="twitter:description" content="Model training, evaluation and selection for multiple time series">
<meta name="twitter:image" content="https://bthek1.github.io/TimeSeries_ML/Nixtla/334_Nixtla - Neural_Advanced_files/figure-html/cell-5-output-2.png">
<meta name="twitter:image-height" content="1161">
<meta name="twitter:image-width" content="1973">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../Logo.svg" alt="Quarto logo." class="navbar-logo">
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-deep-learning" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Deep Learning</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-deep-learning">    
        <li>
    <a class="dropdown-item" href="https://bthek1.github.io/FastAI_course/">
 <span class="dropdown-text">Fast AI course</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://bthek1.github.io/DL_methods/">
 <span class="dropdown-text">DL Methods</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://bthek1.github.io/Research/">
 <span class="dropdown-text">Research</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-ml-techniques" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">ML Techniques</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-ml-techniques">    
        <li>
    <a class="dropdown-item" href="https://bthek1.github.io/ML_methods/">
 <span class="dropdown-text">ML Methods</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://bthek1.github.io/TimeSeriesML/">
 <span class="dropdown-text">Time series</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-web" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Web</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-web">    
        <li>
    <a class="dropdown-item" href="https://bthek1.github.io/WEB_doc/">
 <span class="dropdown-text">Web Development</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://bthek1.github.io/Front_End/">
 <span class="dropdown-text">Front End</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://bthek1.github.io/Back_End/">
 <span class="dropdown-text">Back End</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://bthek1.github.io/Docker_Containers/">
 <span class="dropdown-text">Docker Containers</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-tools" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Tools</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-tools">    
        <li>
    <a class="dropdown-item" href="https://bthek1.github.io/Software_Tools/">
 <span class="dropdown-text">Software Tools</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://bthek1.github.io/Hardware_Tools/">
 <span class="dropdown-text">Hardware Tools</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://bthek1.github.io/Python_Libs/">
 <span class="dropdown-text">Python Libraries</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://bthek1.github.io/nbdevAuto/">
 <span class="dropdown-text">Nbdev Automation</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-business" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Business</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-business">    
        <li>
    <a class="dropdown-item" href="https://bthek1.github.io/Business_doc/">
 <span class="dropdown-text">Business Doc</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://bthek1.github.io/Philosophy_doc/">
 <span class="dropdown-text">Ideas Doc</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://bthek1.github.io/Finances/">
 <span class="dropdown-text">Finances</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://bthek1.github.io/Other/">
 <span class="dropdown-text">Other</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="https://bthek1.github.io/B_Blog/"> 
<span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-help" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Help</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-help">    
        <li>
    <a class="dropdown-item" href="https://github.com/bthek1/B_Blog/issues"><i class="bi bi-bug" role="img">
</i> 
 <span class="dropdown-text">Report a Bug</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://github.com/bthek1/B_Blog/issues"><i class="bi bi-chat-right-text" role="img">
</i> 
 <span class="dropdown-text">Ask a Question</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://github.com/bthek1/B_Blog/issues"><i class="bi bi-question-circle" role="img">
</i> 
 <span class="dropdown-text">FAQ</span></a>
  </li>  
    </ul>
  </li>
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools tools-wide">
    <a href="https://github.com/bthek1" title="" class="quarto-navigation-tool px-1" aria-label="Github"><i class="bi bi-github"></i></a>
    <a href="https://www.linkedin.com/in/benedict-thekkel/" title="" class="quarto-navigation-tool px-1" aria-label="Linkedin"><i class="bi bi-linkedin"></i></a>
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
  <a href="" class="quarto-reader-toggle quarto-navigation-tool px-1" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../Nixtla/nixtla - statsforecasting.html">Nixtla</a></li><li class="breadcrumb-item"><a href="../Nixtla/nixtla - neural_advanced.html">Nixtla - Neural Advanced Forecast</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><a href="https://bthek1.github.io/TimeSeriesML/">Time Series Analysis</a></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../core.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Phisaver Project</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../xgboost.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">XGBoost</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../xgboost2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">XGBoost: Forecast Energy Consumption</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../prophet.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Hourly Time Series Forecasting using Facebook’s Prophet</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../darts.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Darts</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../hyperparameter optimization.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Darts - Hyper-parameters Optimization for Electricity Load Forecasting</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../xplainable.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Xplainable</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../xclassifier.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Xclassifier</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">FFT</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../FFT/fft_analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">FFT analysis</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../FFT/fft-examples.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Darts - Fast Fourier Transform Forecasting Model (FFT)</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">Nixtla</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Nixtla/nixtla - statsforecasting.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Nixtla - StatsForecasting</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Nixtla/electricityloadforecasting.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Nixtla - Electricity Load Forecast</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Nixtla/electricitypeakforecasting.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Nixtla - Detect Demand Peaks</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Nixtla/nixtla - hierarchicalforecast.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Nixtla - Hierarchical Forecast</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Nixtla/nixtla - mlforecast.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Nixtla - ML Forecast</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Nixtla/nixtla - neuralforecast.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Neural Forecast</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Nixtla/nixtla - exogenous_variables.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Exogenous Variables</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Nixtla/nixtla - neural_save_and_load.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Neural Save and Load Models</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Nixtla/nixtla - neural_advanced.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Nixtla - Neural Advanced Forecast</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Nixtla/nixtla - all_methods.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Statistical, Machine Learning and Neural Forecasting methods</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#install-libraries" id="toc-install-libraries" class="nav-link active" data-scroll-target="#install-libraries">1. Install libraries</a></li>
  <li><a href="#read-the-data" id="toc-read-the-data" class="nav-link" data-scroll-target="#read-the-data">2. Read the data</a></li>
  <li><a href="#explore-data-with-the-plot-method-of-statsforecast" id="toc-explore-data-with-the-plot-method-of-statsforecast" class="nav-link" data-scroll-target="#explore-data-with-the-plot-method-of-statsforecast">3. Explore Data with the plot method of StatsForecast</a></li>
  <li><a href="#train-multiple-models-for-many-series" id="toc-train-multiple-models-for-many-series" class="nav-link" data-scroll-target="#train-multiple-models-for-many-series">4. Train multiple models for many series</a></li>
  <li><a href="#evaluate-the-models-performance" id="toc-evaluate-the-models-performance" class="nav-link" data-scroll-target="#evaluate-the-models-performance">5. Evaluate the model’s performance</a></li>
  <li><a href="#select-the-best-model-for-every-unique-series" id="toc-select-the-best-model-for-every-unique-series" class="nav-link" data-scroll-target="#select-the-best-model-for-every-unique-series">6. Select the best model for every unique series</a></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.dev/bthek1/TimeSeries_ML/blob/main/Nixtla/334_Nixtla - Neural_Advanced.ipynb" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/bthek1/TimeSeries_ML/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../Nixtla/nixtla - statsforecasting.html">Nixtla</a></li><li class="breadcrumb-item"><a href="../Nixtla/nixtla - neural_advanced.html">Nixtla - Neural Advanced Forecast</a></li></ol></nav>
<div class="quarto-title">
<h1 class="title">Nixtla - Neural Advanced Forecast</h1>
</div>

<div>
  <div class="description">
    Model training, evaluation and selection for <a href="https://nixtla.github.io/neuralforecast/models.html">multiple time series</a>
  </div>
</div>


<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Benedict Thekkel </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Prerequesites
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>This Guide assumes basic familiarity with NeuralForecast. For a minimal example visit the <a href="./Getting_Started.ipynb">Quick Start</a></p>
</div>
</div>
</div>
<p>Follow this article for a step to step guide on building a production-ready forecasting pipeline for multiple time series.</p>
<p>During this guide you will gain familiary with the core <code>NueralForecast</code>class and some relevant methods like <code>NeuralForecast.fit</code>, <code>NeuralForecast.predict</code>, and <code>StatsForecast.cross_validation.</code></p>
<p>We will use a classical benchmarking dataset from the M4 competition. The dataset includes time series from different domains like finance, economy and sales. In this example, we will use a subset of the Hourly dataset.</p>
<p>We will model each time series globally Therefore, you will train a set of models for the whole dataset, and then select the best model for each individual time series. NeuralForecast focuses on speed, simplicity, and scalability, which makes it ideal for this task.</p>
<p><strong>Outline:</strong></p>
<ol type="1">
<li>Install packages.</li>
<li>Read the data.</li>
<li>Explore the data.</li>
<li>Train many models globally for the entire dataset.</li>
<li>Evaluate the model’s performance using cross-validation.</li>
<li>Select the best model for every unique time series.</li>
</ol>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-2-contents" aria-controls="callout-2" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Not Covered in this guide
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-2" class="callout-2-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<ul>
<li>Using external regressors or exogenous variables
<ul>
<li>Follow this tutorial to <a href="./Exogenous_Variables.ipynb">include exogenous variables</a> like weather or holidays or static variables like category or family.</li>
</ul></li>
<li>Probabilistic forecasting
<ul>
<li>Follow this tutorial to <a href="./LongHorizon_Probabilistic.ipynb">generate probabilistic forecasts</a></li>
</ul></li>
<li>Transfer Learning
<ul>
<li>Train a model and use it to forecast on different data using <a href="./Transfer_Learning.ipynb">this tutorial</a></li>
</ul></li>
</ul>
</div>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>You can use Colab to run this Notebook interactively <a href="https://colab.research.google.com/github/Nixtla/neuralforecast/blob/main/nbs/examples/Getting_Started_complete.ipynb" target="_parent"><img src="https://colab.research.google.com/assets/colab-badge.svg" alt="Open In Colab"></a></p>
</div>
</div>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>To reduce the computation time, it is recommended to use GPU. Using Colab, do not forget to activate it. Just go to <code>Runtime&gt;Change runtime type</code> and select GPU as hardware accelerator.</p>
</div>
</div>
<section id="install-libraries" class="level2">
<h2 class="anchored" data-anchor-id="install-libraries">1. Install libraries</h2>
<p>We assume you have <code>NeuralForecast</code> already installed. Check this guide for instructions on <a href="./Installation.ipynb">how to install NeuralForecast</a>.</p>
<p>Additionally, we will install <code>s3fs</code> to read from the S3 Filesystem of AWS, <code>statsforecast</code> for plotting, and <code>datasetsforecast</code> for common error metrics like MAE or MASE.</p>
<p>Install the necessary packages using <code>pip install statsforecast s3fs datasetsforecast</code> ``</p>
<p>%%capture ! pip install statsforecast s3fs datasetsforecast</p>
<p>%%capture ! pip install git+https://github.com/Nixtla/neuralforecast.git@main</p>
</section>
<section id="read-the-data" class="level2">
<h2 class="anchored" data-anchor-id="read-the-data">2. Read the data</h2>
<p>We will use pandas to read the M4 Hourly data set stored in a parquet file for efficiency. You can use ordinary pandas operations to read your data in other formats likes <code>.csv</code>.</p>
<p>The input to <code>NeuralForecast</code> is always a data frame in <a href="https://www.theanalysisfactor.com/wide-and-long-data/">long format</a> with three columns: <code>unique_id</code>, <code>ds</code> and <code>y</code>:</p>
<ul>
<li><p>The <code>unique_id</code> (string, int or category) represents an identifier for the series.</p></li>
<li><p>The <code>ds</code> (datestamp or int) column should be either an integer indexing time or a datestampe ideally like YYYY-MM-DD for a date or YYYY-MM-DD HH:MM:SS for a timestamp.</p></li>
<li><p>The <code>y</code> (numeric) represents the measurement we wish to forecast. We will rename the</p></li>
</ul>
<p>This data set already satisfies the requirement.</p>
<p>Depending on your internet connection, this step should take around 10 seconds.</p>
<div id="cell-9" class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>Y_df <span class="op">=</span> pd.read_parquet(<span class="st">'https://datasets-nixtla.s3.amazonaws.com/m4-hourly.parquet'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-10" class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>Y_df.head(), <span class="bu">len</span>(Y_df.unique_id.unique())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(  unique_id  ds      y
 0        H1   1  605.0
 1        H1   2  586.0
 2        H1   3  586.0
 3        H1   4  559.0
 4        H1   5  511.0,
 414)</code></pre>
</div>
</div>
<p>This dataset contains 414 unique series with 900 observations on average. For this example and reproducibility’s sake, we will select only 10 unique IDs. Depending on your processing infrastructure feel free to select more or less series.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Processing time is dependent on the available computing resources. Running this example with the complete dataset takes around 10 minutes in a c5d.24xlarge (96 cores) instance from AWS.</p>
</div>
</div>
<div id="cell-12" class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>uids <span class="op">=</span> Y_df[<span class="st">'unique_id'</span>].unique()[:<span class="dv">10</span>] <span class="co"># Select 10 ids to make the example faster</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>Y_df <span class="op">=</span> Y_df.query(<span class="st">'unique_id in @uids'</span>).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="explore-data-with-the-plot-method-of-statsforecast" class="level2">
<h2 class="anchored" data-anchor-id="explore-data-with-the-plot-method-of-statsforecast">3. Explore Data with the plot method of StatsForecast</h2>
<p>Plot some series using the <code>plot</code> method from the <code>StatsForecast</code> class. This method prints 8 random series from the dataset and is useful for basic EDA.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>The <code>StatsForecast.plot</code> method uses Plotly as a defaul engine. You can change to MatPlotLib by setting <code>engine="matplotlib"</code>.</p>
</div>
</div>
<div id="cell-16" class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> statsforecast <span class="im">import</span> StatsForecast</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>StatsForecast.plot(Y_df, engine<span class="op">=</span><span class="st">'matplotlib'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/home/ben/mambaforge/envs/cfast/lib/python3.11/site-packages/statsforecast/core.py:25: TqdmExperimentalWarning: Using `tqdm.autonotebook.tqdm` in notebook mode. Use `tqdm.tqdm` instead to force console mode (e.g. in jupyter console)
  from tqdm.autonotebook import tqdm</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="334_Nixtla - Neural_Advanced_files/figure-html/cell-5-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="train-multiple-models-for-many-series" class="level2">
<h2 class="anchored" data-anchor-id="train-multiple-models-for-many-series">4. Train multiple models for many series</h2>
<p><code>NeuralForecast</code> can train many models on many time series globally and efficiently.</p>
<div id="cell-18" class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> ray <span class="im">import</span> tune</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> neuralforecast <span class="im">import</span> NeuralForecast</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> neuralforecast.auto <span class="im">import</span> AutoNHITS, AutoLSTM</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> neuralforecast.losses.pytorch <span class="im">import</span> MQLoss</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Each <code>Auto</code> model contains a default search space that was extensively tested on multiple large-scale datasets. Additionally, users can define specific search spaces tailored for particular datasets and tasks.</p>
<p>First, we create a custom search space for the <code>AutoNHITS</code> and <code>AutoLSTM</code> models. Search spaces are specified with dictionaries, where keys corresponds to the model’s hyperparameter and the value is a <code>Tune</code> function to specify how the hyperparameter will be sampled. For example, use <code>randint</code> to sample integers uniformly, and <code>choice</code> to sample values of a list.</p>
<div id="cell-20" class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>config_nhits <span class="op">=</span> {</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"input_size"</span>: tune.choice([<span class="dv">48</span>, <span class="dv">48</span><span class="op">*</span><span class="dv">2</span>, <span class="dv">48</span><span class="op">*</span><span class="dv">3</span>]),              <span class="co"># Length of input window</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"start_padding_enabled"</span>: <span class="va">True</span>,</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"n_blocks"</span>: <span class="dv">5</span><span class="op">*</span>[<span class="dv">1</span>],                                              <span class="co"># Length of input window</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"mlp_units"</span>: <span class="dv">5</span> <span class="op">*</span> [[<span class="dv">64</span>, <span class="dv">64</span>]],                                  <span class="co"># Length of input window</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"n_pool_kernel_size"</span>: tune.choice([<span class="dv">5</span><span class="op">*</span>[<span class="dv">1</span>], <span class="dv">5</span><span class="op">*</span>[<span class="dv">2</span>], <span class="dv">5</span><span class="op">*</span>[<span class="dv">4</span>],         </span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>                                      [<span class="dv">8</span>, <span class="dv">4</span>, <span class="dv">2</span>, <span class="dv">1</span>, <span class="dv">1</span>]]),            <span class="co"># MaxPooling Kernel size</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"n_freq_downsample"</span>: tune.choice([[<span class="dv">8</span>, <span class="dv">4</span>, <span class="dv">2</span>, <span class="dv">1</span>, <span class="dv">1</span>],</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>                                      [<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>]]),            <span class="co"># Interpolation expressivity ratios</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"learning_rate"</span>: tune.loguniform(<span class="fl">1e-4</span>, <span class="fl">1e-2</span>),                   <span class="co"># Initial Learning rate</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"scaler_type"</span>: tune.choice([<span class="va">None</span>]),                             <span class="co"># Scaler type</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"max_steps"</span>: tune.choice([<span class="dv">1000</span>]),                               <span class="co"># Max number of training iterations</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"batch_size"</span>: tune.choice([<span class="dv">1</span>, <span class="dv">4</span>, <span class="dv">10</span>]),                          <span class="co"># Number of series in batch</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">"windows_batch_size"</span>: tune.choice([<span class="dv">128</span>, <span class="dv">256</span>, <span class="dv">512</span>]),             <span class="co"># Number of windows in batch</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">"random_seed"</span>: tune.randint(<span class="dv">1</span>, <span class="dv">20</span>),                             <span class="co"># Random seed</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>config_lstm <span class="op">=</span> {</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">"input_size"</span>: tune.choice([<span class="dv">48</span>, <span class="dv">48</span><span class="op">*</span><span class="dv">2</span>, <span class="dv">48</span><span class="op">*</span><span class="dv">3</span>]),              <span class="co"># Length of input window</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">"encoder_hidden_size"</span>: tune.choice([<span class="dv">64</span>, <span class="dv">128</span>]),            <span class="co"># Hidden size of LSTM cells</span></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>    <span class="st">"encoder_n_layers"</span>: tune.choice([<span class="dv">2</span>,<span class="dv">4</span>]),                   <span class="co"># Number of layers in LSTM</span></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>    <span class="st">"learning_rate"</span>: tune.loguniform(<span class="fl">1e-4</span>, <span class="fl">1e-2</span>),             <span class="co"># Initial Learning rate</span></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>    <span class="st">"scaler_type"</span>: tune.choice([<span class="st">'robust'</span>]),                   <span class="co"># Scaler type</span></span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>    <span class="st">"max_steps"</span>: tune.choice([<span class="dv">500</span>, <span class="dv">1000</span>]),                    <span class="co"># Max number of training iterations</span></span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>    <span class="st">"batch_size"</span>: tune.choice([<span class="dv">1</span>, <span class="dv">4</span>]),                        <span class="co"># Number of series in batch</span></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>    <span class="st">"random_seed"</span>: tune.randint(<span class="dv">1</span>, <span class="dv">20</span>),                       <span class="co"># Random seed</span></span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To instantiate an <code>Auto</code> model you need to define:</p>
<ul>
<li><code>h</code>: forecasting horizon.</li>
<li><code>loss</code>: training and validation loss from <code>neuralforecast.losses.pytorch</code>.</li>
<li><code>config</code>: hyperparameter search space. If <code>None</code>, the <code>Auto</code> class will use a pre-defined suggested hyperparameter space.</li>
<li><code>search_alg</code>: search algorithm (from <code>tune.search</code>), default is random search. Refer to https://docs.ray.io/en/latest/tune/api_docs/suggestion.html for more information on the different search algorithm options.</li>
<li><code>num_samples</code>: number of configurations explored.</li>
</ul>
<p>In this example we set horizon <code>h</code> as 48, use the <code>MQLoss</code> distribution loss for training and validation, and use the default search algorithm.</p>
<div id="cell-22" class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>nf <span class="op">=</span> NeuralForecast(</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    models<span class="op">=</span>[</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>        AutoNHITS(h<span class="op">=</span><span class="dv">48</span>, config<span class="op">=</span>config_nhits, loss<span class="op">=</span>MQLoss(), num_samples<span class="op">=</span><span class="dv">5</span>),</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>        AutoLSTM(h<span class="op">=</span><span class="dv">48</span>, config<span class="op">=</span>config_lstm, loss<span class="op">=</span>MQLoss(), num_samples<span class="op">=</span><span class="dv">2</span>),</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    freq<span class="op">=</span><span class="st">'H'</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>The number of samples, <code>num_samples</code>, is a crucial parameter! Larger values will usually produce better results as we explore more configurations in the search space, but it will increase training times. Larger search spaces will usually require more samples. As a general rule, we recommend setting <code>num_samples</code> higher than 20.</p>
</div>
</div>
<p>Next, we use the <code>Neuralforecast</code> class to train the <code>Auto</code> model. In this step, <code>Auto</code> models will automatically perform hyperparameter tuning training multiple models with different hyperparameters, producing the forecasts on the validation set, and evaluating them. The best configuration is selected based on the error on a validation set. Only the best model is stored and used during inference.</p>
<div id="cell-26" class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>nf.fit(df<span class="op">=</span>Y_df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>2023-12-08 16:03:28,784 INFO worker.py:1673 -- Started a local Ray instance.
2023-12-08 16:03:31,402 INFO tune.py:220 -- Initializing Ray automatically. For cluster usage or custom Ray initialization, call `ray.init(...)` before `Tuner(...)`.
2023-12-08 16:03:31,405 INFO tune.py:586 -- [output] This uses the legacy output and progress reporter, as Jupyter notebooks are not supported by the new engine, yet. For more information, please see https://github.com/ray-project/ray/issues/36949
2023-12-08 16:04:31,718 WARNING insufficient_resources_manager.py:163 -- Ignore this message if the cluster is autoscaling. No trial is running and no new trial has been started within the last 60 seconds. This could be due to the cluster not having enough resources available. You asked for 0 CPUs and 1.0 GPUs per trial, but the cluster only has 12.0 CPUs and 0 GPUs available. Stop the tuning and adjust the required resources (e.g. via the `ScalingConfig` or `resources_per_trial`, or `num_workers` for rllib), or add more resources to your cluster.
2023-12-08 16:05:31,748 WARNING insufficient_resources_manager.py:163 -- Ignore this message if the cluster is autoscaling. No trial is running and no new trial has been started within the last 60 seconds. This could be due to the cluster not having enough resources available. You asked for 0 CPUs and 1.0 GPUs per trial, but the cluster only has 12.0 CPUs and 0 GPUs available. Stop the tuning and adjust the required resources (e.g. via the `ScalingConfig` or `resources_per_trial`, or `num_workers` for rllib), or add more resources to your cluster.
2023-12-08 16:05:36,474 WARNING tune.py:186 -- Stop signal received (e.g. via SIGINT/Ctrl+C), ending Ray Tune run. This will try to checkpoint the experiment state one last time. Press CTRL+C (or send SIGINT/SIGKILL/SIGTERM) to skip. 
2023-12-08 16:05:36,490 WARNING tune.py:1062 -- Experiment has been interrupted, but the most recent state was saved.
Resume experiment with: Tuner.restore(path="/home/ben/ray_results/_train_tune_2023-12-08_16-03-25", trainable=...)
2023-12-08 16:05:36,495 WARNING experiment_analysis.py:185 -- Failed to fetch metrics for 5 trial(s):
- _train_tune_7b276_00000: FileNotFoundError('Could not fetch metrics for _train_tune_7b276_00000: both result.json and progress.csv were not found at /home/ben/ray_results/_train_tune_2023-12-08_16-03-25/_train_tune_7b276_00000_0_batch_size=10,input_size=96,learning_rate=0.0002,max_steps=1000,n_freq_downsample=1_1_1_1_1,n_pool_kerne_2023-12-08_16-03-31')
- _train_tune_7b276_00001: FileNotFoundError('Could not fetch metrics for _train_tune_7b276_00001: both result.json and progress.csv were not found at /home/ben/ray_results/_train_tune_2023-12-08_16-03-25/_train_tune_7b276_00001_1_batch_size=4,input_size=48,learning_rate=0.0045,max_steps=1000,n_freq_downsample=1_1_1_1_1,n_pool_kernel_2023-12-08_16-03-31')
- _train_tune_7b276_00002: FileNotFoundError('Could not fetch metrics for _train_tune_7b276_00002: both result.json and progress.csv were not found at /home/ben/ray_results/_train_tune_2023-12-08_16-03-25/_train_tune_7b276_00002_2_batch_size=1,input_size=96,learning_rate=0.0032,max_steps=1000,n_freq_downsample=8_4_2_1_1,n_pool_kernel_2023-12-08_16-03-31')
- _train_tune_7b276_00003: FileNotFoundError('Could not fetch metrics for _train_tune_7b276_00003: both result.json and progress.csv were not found at /home/ben/ray_results/_train_tune_2023-12-08_16-03-25/_train_tune_7b276_00003_3_batch_size=10,input_size=144,learning_rate=0.0004,max_steps=1000,n_freq_downsample=8_4_2_1_1,n_pool_kern_2023-12-08_16-03-31')
- _train_tune_7b276_00004: FileNotFoundError('Could not fetch metrics for _train_tune_7b276_00004: both result.json and progress.csv were not found at /home/ben/ray_results/_train_tune_2023-12-08_16-03-25/_train_tune_7b276_00004_4_batch_size=4,input_size=144,learning_rate=0.0003,max_steps=1000,n_freq_downsample=8_4_2_1_1,n_pool_kerne_2023-12-08_16-03-31')
2023-12-08 16:05:36,495 WARNING experiment_analysis.py:575 -- Could not find best trial. Did you pass the correct `metric` parameter?</code></pre>
</div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">RuntimeError</span>                              Traceback (most recent call last)
Cell <span class="ansi-green-fg">In[14], line 1</span>
<span class="ansi-green-fg">----&gt; 1</span> <span class="ansi-yellow-bg">nf</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">fit</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">df</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">Y_df</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/mambaforge/envs/cfast/lib/python3.11/site-packages/neuralforecast/core.py:274</span>, in <span class="ansi-cyan-fg">NeuralForecast.fit</span><span class="ansi-blue-fg">(self, df, static_df, val_size, sort_df, use_init_models, verbose)</span>
<span class="ansi-green-fg ansi-bold">    271</span>         <span style="color:rgb(0,135,0)">print</span>(<span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">WARNING: Deleting previously fitted models.</span><span style="color:rgb(175,0,0)">"</span>)
<span class="ansi-green-fg ansi-bold">    273</span> <span style="font-weight:bold;color:rgb(0,135,0)">for</span> model <span style="font-weight:bold;color:rgb(175,0,255)">in</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>models:
<span class="ansi-green-fg">--&gt; 274</span>     <span class="ansi-yellow-bg">model</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">fit</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">dataset</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">val_size</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">val_size</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    276</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_fitted <span style="color:rgb(98,98,98)">=</span> <span style="font-weight:bold;color:rgb(0,135,0)">True</span>

File <span class="ansi-green-fg">~/mambaforge/envs/cfast/lib/python3.11/site-packages/neuralforecast/common/_base_auto.py:373</span>, in <span class="ansi-cyan-fg">BaseAuto.fit</span><span class="ansi-blue-fg">(self, dataset, val_size, test_size, random_seed)</span>
<span class="ansi-green-fg ansi-bold">    360</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>backend <span style="color:rgb(98,98,98)">==</span> <span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">ray</span><span style="color:rgb(175,0,0)">"</span>:
<span class="ansi-green-fg ansi-bold">    361</span>     results <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_tune_model(
<span class="ansi-green-fg ansi-bold">    362</span>         cls_model<span style="color:rgb(98,98,98)">=</span><span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>cls_model,
<span class="ansi-green-fg ansi-bold">    363</span>         dataset<span style="color:rgb(98,98,98)">=</span>dataset,
<span class="ansi-green-fg">   (...)</span>
<span class="ansi-green-fg ansi-bold">    371</span>         config<span style="color:rgb(98,98,98)">=</span><span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>config,
<span class="ansi-green-fg ansi-bold">    372</span>     )
<span class="ansi-green-fg">--&gt; 373</span>     best_config <span style="color:rgb(98,98,98)">=</span> <span class="ansi-yellow-bg">results</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">get_best_result</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">)</span><span style="color:rgb(98,98,98)">.</span>config
<span class="ansi-green-fg ansi-bold">    374</span> <span style="font-weight:bold;color:rgb(0,135,0)">else</span>:
<span class="ansi-green-fg ansi-bold">    375</span>     results <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_optuna_tune_model(
<span class="ansi-green-fg ansi-bold">    376</span>         cls_model<span style="color:rgb(98,98,98)">=</span><span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>cls_model,
<span class="ansi-green-fg ansi-bold">    377</span>         dataset<span style="color:rgb(98,98,98)">=</span>dataset,
<span class="ansi-green-fg">   (...)</span>
<span class="ansi-green-fg ansi-bold">    383</span>         config<span style="color:rgb(98,98,98)">=</span><span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>config,
<span class="ansi-green-fg ansi-bold">    384</span>     )

File <span class="ansi-green-fg">~/mambaforge/envs/cfast/lib/python3.11/site-packages/ray/tune/result_grid.py:162</span>, in <span class="ansi-cyan-fg">ResultGrid.get_best_result</span><span class="ansi-blue-fg">(self, metric, mode, scope, filter_nan_and_inf)</span>
<span class="ansi-green-fg ansi-bold">    151</span>     error_msg <span style="color:rgb(98,98,98)">=</span> (
<span class="ansi-green-fg ansi-bold">    152</span>         <span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">No best trial found for the given metric: </span><span style="color:rgb(175,0,0)">"</span>
<span class="ansi-green-fg ansi-bold">    153</span>         <span style="color:rgb(175,0,0)">f</span><span style="color:rgb(175,0,0)">"</span><span style="font-weight:bold;color:rgb(175,95,135)">{</span>metric<span style="color:rgb(188,188,188)"> </span><span style="font-weight:bold;color:rgb(175,0,255)">or</span><span style="color:rgb(188,188,188)"> </span><span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_experiment_analysis<span style="color:rgb(98,98,98)">.</span>default_metric<span style="font-weight:bold;color:rgb(175,95,135)">}</span><span style="color:rgb(175,0,0)">. </span><span style="color:rgb(175,0,0)">"</span>
<span class="ansi-green-fg ansi-bold">    154</span>         <span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">This means that no trial has reported this metric</span><span style="color:rgb(175,0,0)">"</span>
<span class="ansi-green-fg ansi-bold">    155</span>     )
<span class="ansi-green-fg ansi-bold">    156</span>     error_msg <span style="color:rgb(98,98,98)">+</span><span style="color:rgb(98,98,98)">=</span> (
<span class="ansi-green-fg ansi-bold">    157</span>         <span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">, or all values reported for this metric are NaN. To not ignore NaN </span><span style="color:rgb(175,0,0)">"</span>
<span class="ansi-green-fg ansi-bold">    158</span>         <span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">values, you can set the `filter_nan_and_inf` arg to False.</span><span style="color:rgb(175,0,0)">"</span>
<span class="ansi-green-fg ansi-bold">    159</span>         <span style="font-weight:bold;color:rgb(0,135,0)">if</span> filter_nan_and_inf
<span class="ansi-green-fg ansi-bold">    160</span>         <span style="font-weight:bold;color:rgb(0,135,0)">else</span> <span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">.</span><span style="color:rgb(175,0,0)">"</span>
<span class="ansi-green-fg ansi-bold">    161</span>     )
<span class="ansi-green-fg">--&gt; 162</span>     <span style="font-weight:bold;color:rgb(0,135,0)">raise</span> <span style="font-weight:bold;color:rgb(215,95,95)">RuntimeError</span>(error_msg)
<span class="ansi-green-fg ansi-bold">    164</span> <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_trial_to_result(best_trial)

<span class="ansi-red-fg">RuntimeError</span>: No best trial found for the given metric: loss. This means that no trial has reported this metric, or all values reported for this metric are NaN. To not ignore NaN values, you can set the `filter_nan_and_inf` arg to False.</pre>
</div>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>(raylet) [2023-12-08 16:11:28,719 E 602035 602035] (raylet) node_manager.cc:3035: 5 Workers (tasks / actors) killed due to memory pressure (OOM), 0 Workers crashed due to other reasons at node (ID: 0e206a13d87f7d2f8b01010d06fa0b550b64bbb8773293ab52e0686e, IP: 172.19.100.51) over the last time period. To see more information about the Workers killed on this node, use `ray logs raylet.out -ip 172.19.100.51`
(raylet) 
(raylet) Refer to the documentation on how to address the out of memory issue: https://docs.ray.io/en/latest/ray-core/scheduling/ray-oom-prevention.html. Consider provisioning more memory on this node or reducing task parallelism by requesting more CPUs per task. To adjust the kill threshold, set the environment variable `RAY_memory_usage_threshold` when starting Ray. To disable worker killing, set the environment variable `RAY_memory_monitor_refresh_ms` to zero.
(raylet) [2023-12-08 16:21:28,835 E 602035 602035] (raylet) node_manager.cc:3035: 7 Workers (tasks / actors) killed due to memory pressure (OOM), 0 Workers crashed due to other reasons at node (ID: 0e206a13d87f7d2f8b01010d06fa0b550b64bbb8773293ab52e0686e, IP: 172.19.100.51) over the last time period. To see more information about the Workers killed on this node, use `ray logs raylet.out -ip 172.19.100.51`
(raylet) 
(raylet) Refer to the documentation on how to address the out of memory issue: https://docs.ray.io/en/latest/ray-core/scheduling/ray-oom-prevention.html. Consider provisioning more memory on this node or reducing task parallelism by requesting more CPUs per task. To adjust the kill threshold, set the environment variable `RAY_memory_usage_threshold` when starting Ray. To disable worker killing, set the environment variable `RAY_memory_monitor_refresh_ms` to zero.</code></pre>
</div>
</div>
<p>Next, we use the <code>predict</code> method to forecast the next 48 days using the optimal hyperparameters.</p>
<div id="cell-28" class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>fcst_df <span class="op">=</span> nf.predict()</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>fcst_df.columns <span class="op">=</span> fcst_df.columns.<span class="bu">str</span>.replace(<span class="st">'-median'</span>, <span class="st">''</span>)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>fcst_df.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Predicting DataLoader 0: 100%|██████████| 3/3 [00:00&lt;00:00, 164.16it/s]
Predicting DataLoader 0: 100%|██████████| 3/3 [00:00&lt;00:00, 13.89it/s]</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">ds</th>
<th data-quarto-table-cell-role="th">AutoNHITS</th>
<th data-quarto-table-cell-role="th">AutoNHITS-lo-90</th>
<th data-quarto-table-cell-role="th">AutoNHITS-lo-80</th>
<th data-quarto-table-cell-role="th">AutoNHITS-hi-80</th>
<th data-quarto-table-cell-role="th">AutoNHITS-hi-90</th>
<th data-quarto-table-cell-role="th">AutoLSTM</th>
<th data-quarto-table-cell-role="th">AutoLSTM-lo-90</th>
<th data-quarto-table-cell-role="th">AutoLSTM-lo-80</th>
<th data-quarto-table-cell-role="th">AutoLSTM-hi-80</th>
<th data-quarto-table-cell-role="th">AutoLSTM-hi-90</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">unique_id</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">H1</td>
<td>749</td>
<td>550.545288</td>
<td>491.368347</td>
<td>484.838226</td>
<td>640.832520</td>
<td>658.631592</td>
<td>581.597534</td>
<td>510.460632</td>
<td>533.967041</td>
<td>660.153076</td>
<td>690.976379</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">H1</td>
<td>750</td>
<td>549.216736</td>
<td>491.054932</td>
<td>484.474243</td>
<td>639.552002</td>
<td>657.615967</td>
<td>530.324402</td>
<td>440.821899</td>
<td>472.254272</td>
<td>622.214539</td>
<td>653.435913</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">H1</td>
<td>751</td>
<td>528.075989</td>
<td>466.917053</td>
<td>463.002289</td>
<td>621.197205</td>
<td>642.255005</td>
<td>487.045593</td>
<td>383.502045</td>
<td>423.310974</td>
<td>594.273071</td>
<td>627.640320</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">H1</td>
<td>752</td>
<td>486.842255</td>
<td>418.012115</td>
<td>419.017242</td>
<td>585.653259</td>
<td>611.903809</td>
<td>457.408081</td>
<td>347.901093</td>
<td>390.807495</td>
<td>569.789062</td>
<td>604.200012</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">H1</td>
<td>753</td>
<td>452.015930</td>
<td>371.543884</td>
<td>379.539215</td>
<td>558.845154</td>
<td>590.465942</td>
<td>441.641418</td>
<td>333.888611</td>
<td>374.730621</td>
<td>557.401978</td>
<td>595.008484</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="cell-29" class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>StatsForecast.plot(Y_df, fcst_df, engine<span class="op">=</span><span class="st">'matplotlib'</span>, max_insample_length<span class="op">=</span><span class="dv">48</span> <span class="op">*</span> <span class="dv">3</span>, level<span class="op">=</span>[<span class="dv">80</span>, <span class="dv">90</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="334_Nixtla - Neural_Advanced_files/figure-html/cell-12-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>The <code>StatsForecast.plot</code> allows for further customization. For example, plot the results of the different models and unique ids.</p>
<div id="cell-31" class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot to unique_ids and some selected models</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>StatsForecast.plot(Y_df, fcst_df, models<span class="op">=</span>[<span class="st">"AutoLSTM"</span>], unique_ids<span class="op">=</span>[<span class="st">"H107"</span>, <span class="st">"H104"</span>], level<span class="op">=</span>[<span class="dv">80</span>, <span class="dv">90</span>], engine<span class="op">=</span><span class="st">'matplotlib'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="334_Nixtla - Neural_Advanced_files/figure-html/cell-13-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-32" class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Explore other models </span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>StatsForecast.plot(Y_df, fcst_df, models<span class="op">=</span>[<span class="st">"AutoNHITS"</span>], unique_ids<span class="op">=</span>[<span class="st">"H10"</span>, <span class="st">"H105"</span>], level<span class="op">=</span>[<span class="dv">80</span>, <span class="dv">90</span>], engine<span class="op">=</span><span class="st">'matplotlib'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="334_Nixtla - Neural_Advanced_files/figure-html/cell-14-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="evaluate-the-models-performance" class="level2">
<h2 class="anchored" data-anchor-id="evaluate-the-models-performance">5. Evaluate the model’s performance</h2>
<p>In previous steps, we’ve taken our historical data to predict the future. However, to asses its accuracy we would also like to know how the model would have performed in the past. To assess the accuracy and robustness of your models on your data perform Cross-Validation.</p>
<p>With time series data, <strong>Cross Validation</strong> is done by defining a sliding window across the historical data and predicting the period following it. This form of cross-validation allows us to arrive at a better estimation of our model’s predictive abilities across a wider range of temporal instances while also keeping the data in the training set contiguous as is required by our models.</p>
<p>The following graph depicts such a Cross Validation Strategy:</p>
<p><img src="https://raw.githubusercontent.com/Nixtla/statsforecast/main/nbs/imgs/ChainedWindows.gif" class="img-fluid"></p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>Setting <code>n_windows=1</code> mirrors a traditional train-test split with our historical data serving as the training set and the last 48 hours serving as the testing set.</p>
</div>
</div>
<p>The <code>cross_validation</code> method from the <code>NeuralForecast</code> class takes the following arguments.</p>
<ul>
<li><p><code>df</code>: training data frame</p></li>
<li><p><code>step_size</code> (int): step size between each window. In other words: how often do you want to run the forecasting processes.</p></li>
<li><p><code>n_windows</code> (int): number of windows used for cross validation. In other words: what number of forecasting processes in the past do you want to evaluate.</p></li>
</ul>
<div id="cell-36" class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> neuralforecast.auto <span class="im">import</span> AutoNHITS, AutoLSTM</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>config_nhits <span class="op">=</span> {</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"input_size"</span>: tune.choice([<span class="dv">48</span>, <span class="dv">48</span><span class="op">*</span><span class="dv">2</span>, <span class="dv">48</span><span class="op">*</span><span class="dv">3</span>]),              <span class="co"># Length of input window</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"start_padding_enabled"</span>: <span class="va">True</span>,</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"n_blocks"</span>: <span class="dv">5</span><span class="op">*</span>[<span class="dv">1</span>],                                              <span class="co"># Length of input window</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"mlp_units"</span>: <span class="dv">5</span> <span class="op">*</span> [[<span class="dv">64</span>, <span class="dv">64</span>]],                                  <span class="co"># Length of input window</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"n_pool_kernel_size"</span>: tune.choice([<span class="dv">5</span><span class="op">*</span>[<span class="dv">1</span>], <span class="dv">5</span><span class="op">*</span>[<span class="dv">2</span>], <span class="dv">5</span><span class="op">*</span>[<span class="dv">4</span>],         </span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>                                      [<span class="dv">8</span>, <span class="dv">4</span>, <span class="dv">2</span>, <span class="dv">1</span>, <span class="dv">1</span>]]),            <span class="co"># MaxPooling Kernel size</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"n_freq_downsample"</span>: tune.choice([[<span class="dv">8</span>, <span class="dv">4</span>, <span class="dv">2</span>, <span class="dv">1</span>, <span class="dv">1</span>],</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>                                      [<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>]]),            <span class="co"># Interpolation expressivity ratios</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"learning_rate"</span>: tune.loguniform(<span class="fl">1e-4</span>, <span class="fl">1e-2</span>),                   <span class="co"># Initial Learning rate</span></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"scaler_type"</span>: tune.choice([<span class="va">None</span>]),                             <span class="co"># Scaler type</span></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"max_steps"</span>: tune.choice([<span class="dv">1000</span>]),                               <span class="co"># Max number of training iterations</span></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">"batch_size"</span>: tune.choice([<span class="dv">1</span>, <span class="dv">4</span>, <span class="dv">10</span>]),                          <span class="co"># Number of series in batch</span></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">"windows_batch_size"</span>: tune.choice([<span class="dv">128</span>, <span class="dv">256</span>, <span class="dv">512</span>]),             <span class="co"># Number of windows in batch</span></span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">"random_seed"</span>: tune.randint(<span class="dv">1</span>, <span class="dv">20</span>),                             <span class="co"># Random seed</span></span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>config_lstm <span class="op">=</span> {</span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">"input_size"</span>: tune.choice([<span class="dv">48</span>, <span class="dv">48</span><span class="op">*</span><span class="dv">2</span>, <span class="dv">48</span><span class="op">*</span><span class="dv">3</span>]),              <span class="co"># Length of input window</span></span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>    <span class="st">"encoder_hidden_size"</span>: tune.choice([<span class="dv">64</span>, <span class="dv">128</span>]),            <span class="co"># Hidden size of LSTM cells</span></span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>    <span class="st">"encoder_n_layers"</span>: tune.choice([<span class="dv">2</span>,<span class="dv">4</span>]),                   <span class="co"># Number of layers in LSTM</span></span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>    <span class="st">"learning_rate"</span>: tune.loguniform(<span class="fl">1e-4</span>, <span class="fl">1e-2</span>),             <span class="co"># Initial Learning rate</span></span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a>    <span class="st">"scaler_type"</span>: tune.choice([<span class="st">'robust'</span>]),                   <span class="co"># Scaler type</span></span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a>    <span class="st">"max_steps"</span>: tune.choice([<span class="dv">500</span>, <span class="dv">1000</span>]),                    <span class="co"># Max number of training iterations</span></span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a>    <span class="st">"batch_size"</span>: tune.choice([<span class="dv">1</span>, <span class="dv">4</span>]),                        <span class="co"># Number of series in batch</span></span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a>    <span class="st">"random_seed"</span>: tune.randint(<span class="dv">1</span>, <span class="dv">20</span>),                       <span class="co"># Random seed</span></span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a>nf <span class="op">=</span> NeuralForecast(</span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a>    models<span class="op">=</span>[</span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a>        AutoNHITS(h<span class="op">=</span><span class="dv">48</span>, config<span class="op">=</span>config_nhits, loss<span class="op">=</span>MQLoss(), num_samples<span class="op">=</span><span class="dv">5</span>),</span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a>        AutoLSTM(h<span class="op">=</span><span class="dv">48</span>, config<span class="op">=</span>config_lstm, loss<span class="op">=</span>MQLoss(), num_samples<span class="op">=</span><span class="dv">2</span>), </span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb18-34"><a href="#cb18-34" aria-hidden="true" tabindex="-1"></a>    freq<span class="op">=</span><span class="st">'H'</span></span>
<span id="cb18-35"><a href="#cb18-35" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-37" class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>cv_df <span class="op">=</span> nf.cross_validation(Y_df, n_windows<span class="op">=</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Global seed set to 4
Global seed set to 19</code></pre>
</div>
</div>
<p>The <code>cv_df</code> object is a new data frame that includes the following columns:</p>
<ul>
<li><code>unique_id</code>: identifies each time series</li>
<li><code>ds</code>: datestamp or temporal index</li>
<li><code>cutoff</code>: the last datestamp or temporal index for the n_windows. If n_windows=1, then one unique cuttoff value, if n_windows=2 then two unique cutoff values.</li>
<li><code>y</code>: true value</li>
<li><code>"model"</code>: columns with the model’s name and fitted value.</li>
</ul>
<div id="cell-39" class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>cv_df.columns <span class="op">=</span> cv_df.columns.<span class="bu">str</span>.replace(<span class="st">'-median'</span>, <span class="st">''</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-40" class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>cv_df.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">unique_id</th>
<th data-quarto-table-cell-role="th">ds</th>
<th data-quarto-table-cell-role="th">cutoff</th>
<th data-quarto-table-cell-role="th">AutoNHITS</th>
<th data-quarto-table-cell-role="th">AutoNHITS-lo-90</th>
<th data-quarto-table-cell-role="th">AutoNHITS-lo-80</th>
<th data-quarto-table-cell-role="th">AutoNHITS-hi-80</th>
<th data-quarto-table-cell-role="th">AutoNHITS-hi-90</th>
<th data-quarto-table-cell-role="th">AutoLSTM</th>
<th data-quarto-table-cell-role="th">AutoLSTM-lo-90</th>
<th data-quarto-table-cell-role="th">AutoLSTM-lo-80</th>
<th data-quarto-table-cell-role="th">AutoLSTM-hi-80</th>
<th data-quarto-table-cell-role="th">AutoLSTM-hi-90</th>
<th data-quarto-table-cell-role="th">y</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>H1</td>
<td>700</td>
<td>699</td>
<td>646.881714</td>
<td>601.402893</td>
<td>626.471008</td>
<td>672.432617</td>
<td>683.847778</td>
<td>633.707031</td>
<td>365.139832</td>
<td>407.289246</td>
<td>871.474976</td>
<td>925.476196</td>
<td>684.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>H1</td>
<td>701</td>
<td>699</td>
<td>635.608643</td>
<td>595.042908</td>
<td>612.889771</td>
<td>669.565979</td>
<td>679.472900</td>
<td>632.455017</td>
<td>365.303131</td>
<td>406.472992</td>
<td>869.484985</td>
<td>922.926514</td>
<td>619.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>H1</td>
<td>702</td>
<td>699</td>
<td>592.663940</td>
<td>564.124390</td>
<td>566.502319</td>
<td>648.286072</td>
<td>647.859253</td>
<td>633.002502</td>
<td>365.147522</td>
<td>407.174866</td>
<td>868.677979</td>
<td>925.269409</td>
<td>565.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>H1</td>
<td>703</td>
<td>699</td>
<td>543.364563</td>
<td>516.760742</td>
<td>517.990234</td>
<td>603.099182</td>
<td>601.462280</td>
<td>633.903503</td>
<td>364.976746</td>
<td>408.498779</td>
<td>869.797180</td>
<td>925.993164</td>
<td>532.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>H1</td>
<td>704</td>
<td>699</td>
<td>498.051178</td>
<td>461.069489</td>
<td>474.206360</td>
<td>540.752563</td>
<td>555.169739</td>
<td>634.015991</td>
<td>363.384155</td>
<td>408.305298</td>
<td>870.154297</td>
<td>920.329224</td>
<td>495.0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="cell-41" class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> cutoff <span class="kw">in</span> cv_df[<span class="st">'cutoff'</span>].unique():</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>    StatsForecast.plot(</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>        Y_df, </span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>        cv_df.query(<span class="st">'cutoff == @cutoff'</span>).drop(columns<span class="op">=</span>[<span class="st">'y'</span>, <span class="st">'cutoff'</span>]), </span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>        max_insample_length<span class="op">=</span><span class="dv">48</span> <span class="op">*</span> <span class="dv">4</span>, </span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>        unique_ids<span class="op">=</span>[<span class="st">'H185'</span>],</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>        engine<span class="op">=</span><span class="st">'matplotlib'</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now, let’s evaluate the models’ performance.</p>
<div id="cell-43" class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datasetsforecast.losses <span class="im">import</span> mse, mae, rmse</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datasetsforecast.evaluation <span class="im">import</span> accuracy</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>You can also use Mean Average Percentage Error (MAPE), however for granular forecasts, MAPE values are extremely <a href="&quot;https://blog.blueyonder.com/mean-absolute-percentage-error-mape-has-served-its-duty-and-should-now-retire/&quot;">hard to judge</a> and not useful to assess forecasting quality.</p>
</div>
</div>
<p>Create the data frame with the results of the evaluation of your cross-validation data frame using a Mean Squared Error metric.</p>
<div id="cell-46" class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>evaluation_df <span class="op">=</span> accuracy(cv_df, [mse, mae, rmse], agg_by<span class="op">=</span>[<span class="st">'unique_id'</span>])</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>evaluation_df[<span class="st">'best_model'</span>] <span class="op">=</span> evaluation_df.drop(columns<span class="op">=</span>[<span class="st">'metric'</span>, <span class="st">'unique_id'</span>]).idxmin(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>evaluation_df.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">metric</th>
<th data-quarto-table-cell-role="th">unique_id</th>
<th data-quarto-table-cell-role="th">AutoNHITS</th>
<th data-quarto-table-cell-role="th">AutoLSTM</th>
<th data-quarto-table-cell-role="th">best_model</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>mae</td>
<td>H1</td>
<td>38.259457</td>
<td>131.158150</td>
<td>AutoNHITS</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>mae</td>
<td>H10</td>
<td>14.044900</td>
<td>32.972164</td>
<td>AutoNHITS</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>mae</td>
<td>H100</td>
<td>254.464978</td>
<td>281.836064</td>
<td>AutoNHITS</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>mae</td>
<td>H101</td>
<td>257.810841</td>
<td>148.341771</td>
<td>AutoLSTM</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>mae</td>
<td>H102</td>
<td>176.114826</td>
<td>472.413350</td>
<td>AutoNHITS</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Create a summary table with a model column and the number of series where that model performs best.</p>
<div id="cell-48" class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>summary_df <span class="op">=</span> evaluation_df.groupby([<span class="st">'metric'</span>, <span class="st">'best_model'</span>]).size().sort_values().to_frame()</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>summary_df <span class="op">=</span> summary_df.reset_index()</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>summary_df.columns <span class="op">=</span> [<span class="st">'metric'</span>, <span class="st">'model'</span>, <span class="st">'nr. of unique_ids'</span>]</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>summary_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">metric</th>
<th data-quarto-table-cell-role="th">model</th>
<th data-quarto-table-cell-role="th">nr. of unique_ids</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>mae</td>
<td>AutoLSTM</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>mse</td>
<td>AutoLSTM</td>
<td>1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>rmse</td>
<td>AutoLSTM</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>mae</td>
<td>AutoNHITS</td>
<td>9</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>mse</td>
<td>AutoNHITS</td>
<td>9</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>rmse</td>
<td>AutoNHITS</td>
<td>9</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="cell-49" class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>summary_df.query(<span class="st">'metric == "mse"'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">metric</th>
<th data-quarto-table-cell-role="th">model</th>
<th data-quarto-table-cell-role="th">nr. of unique_ids</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">1</td>
<td>mse</td>
<td>AutoLSTM</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">4</td>
<td>mse</td>
<td>AutoNHITS</td>
<td>9</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>You can further explore your results by plotting the unique_ids where a specific model wins.</p>
<div id="cell-51" class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>nhits_ids <span class="op">=</span> evaluation_df.query(<span class="st">'best_model == "AutoNHITS" and metric == "mse"'</span>)[<span class="st">'unique_id'</span>].unique()</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>StatsForecast.plot(Y_df, fcst_df, unique_ids<span class="op">=</span>nhits_ids, engine<span class="op">=</span><span class="st">'matplotlib'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="334_Nixtla - Neural_Advanced_files/figure-html/cell-24-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="select-the-best-model-for-every-unique-series" class="level2">
<h2 class="anchored" data-anchor-id="select-the-best-model-for-every-unique-series">6. Select the best model for every unique series</h2>
<p>Define a utility function that takes your forecast’s data frame with the predictions and the evaluation data frame and returns a data frame with the best possible forecast for every unique_id.</p>
<div id="cell-54" class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_best_model_forecast(forecasts_df, evaluation_df, metric):</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> forecasts_df.set_index(<span class="st">'ds'</span>, append<span class="op">=</span><span class="va">True</span>).stack().to_frame().reset_index(level<span class="op">=</span><span class="dv">2</span>) <span class="co"># Wide to long </span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>    df.columns <span class="op">=</span> [<span class="st">'model'</span>, <span class="st">'best_model_forecast'</span>] </span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.join(evaluation_df.query(<span class="st">'metric == @metric'</span>).set_index(<span class="st">'unique_id'</span>)[[<span class="st">'best_model'</span>]])</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.query(<span class="st">'model.str.replace("-lo-90|-hi-90", "", regex=True) == best_model'</span>).copy()</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>    df.loc[:, <span class="st">'model'</span>] <span class="op">=</span> [model.replace(bm, <span class="st">'best_model'</span>) <span class="cf">for</span> model, bm <span class="kw">in</span> <span class="bu">zip</span>(df[<span class="st">'model'</span>], df[<span class="st">'best_model'</span>])]</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.drop(columns<span class="op">=</span><span class="st">'best_model'</span>).set_index(<span class="st">'model'</span>, append<span class="op">=</span><span class="va">True</span>).unstack()</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>    df.columns <span class="op">=</span> df.columns.droplevel()</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.reset_index(level<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Create your production-ready data frame with the best forecast for every unique_id.</p>
<div id="cell-56" class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>prod_forecasts_df <span class="op">=</span> get_best_model_forecast(fcst_df, evaluation_df, metric<span class="op">=</span><span class="st">'mse'</span>)</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>prod_forecasts_df.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">model</th>
<th data-quarto-table-cell-role="th">ds</th>
<th data-quarto-table-cell-role="th">best_model</th>
<th data-quarto-table-cell-role="th">best_model-hi-90</th>
<th data-quarto-table-cell-role="th">best_model-lo-90</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">unique_id</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">H1</td>
<td>749</td>
<td>550.545288</td>
<td>658.631592</td>
<td>491.368347</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">H1</td>
<td>750</td>
<td>549.216736</td>
<td>657.615967</td>
<td>491.054932</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">H1</td>
<td>751</td>
<td>528.075989</td>
<td>642.255005</td>
<td>466.917053</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">H1</td>
<td>752</td>
<td>486.842255</td>
<td>611.903809</td>
<td>418.012115</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">H1</td>
<td>753</td>
<td>452.015930</td>
<td>590.465942</td>
<td>371.543884</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Plot the results.</p>
<div id="cell-58" class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>StatsForecast.plot(Y_df, prod_forecasts_df, level<span class="op">=</span>[<span class="dv">90</span>], engine<span class="op">=</span><span class="st">'matplotlib'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="334_Nixtla - Neural_Advanced_files/figure-html/cell-27-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>


</section>

<a onclick="window.scrollTo(0, 0); return false;" role="button" id="quarto-back-to-top"><i class="bi bi-arrow-up"></i> Back to top</a></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/bthek1\.github\.io\/TimeSeries_ML");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<script src="https://utteranc.es/client.js" repo="quarto-dev/quarto-web" issue-term="pathname" theme="github-light" crossorigin="anonymous" async="">
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../Nixtla/nixtla - neural_save_and_load.html" class="pagination-link" aria-label="Neural Save and Load Models">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Neural Save and Load Models</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../Nixtla/nixtla - all_methods.html" class="pagination-link" aria-label="Statistical, Machine Learning and Neural Forecasting methods">
        <span class="nav-page-text">Statistical, Machine Learning and Neural Forecasting methods</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
      <ul class="footer-items list-unstyled">
    <li class="nav-item">
    <a class="nav-link active" href="../index.html" aria-current="page">
<p>Trademark</p>
</a>
  </li>  
    <li class="nav-item">
    <a class="nav-link" href="https://github.com/bthek1/B_Blog/issues">
<p>FAQ</p>
</a>
  </li>  
    <li class="nav-item">
    <a class="nav-link" href="https://bthek1.github.io/benedicts_blog/Index.html">
<p>License</p>
</a>
  </li>  
    <li class="nav-item">
    <a class="nav-link" href="../index.html">
<p>Trademark</p>
</a>
  </li>  
</ul>
    <div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.dev/bthek1/TimeSeries_ML/blob/main/Nixtla/334_Nixtla - Neural_Advanced.ipynb" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/bthek1/TimeSeries_ML/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div>
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
    <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/bthek1">
      <i class="bi bi-github" role="img" aria-label="Github">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/benedict-thekkel/">
      <i class="bi bi-linkedin" role="img" aria-label="Linkedin">
</i> 
    </a>
  </li>  
</ul>
    </div>
  </div>
</footer>




</body></html>